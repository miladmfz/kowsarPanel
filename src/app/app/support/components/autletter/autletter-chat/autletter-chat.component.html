<div class="card">
  <!-- Header -->
  <div class="border-bottom border-light card-body">
    <div class="d-flex py-1">
      <div class="flex-1">
        <h5><a class="text-reset">مکالمات اخیر</a></h5>
      </div>
    </div>
  </div>

  <!-- Chat List -->
  <div class="card-body">
    <div #scrollContainer class="chat-container" style="height: 465px; overflow-y: auto;">
      <ul class="conversation-list chat-app-conversation">
        <li *ngFor="let chat of chats; let index = index" [ngClass]="{'odd': chat.CentralRef !== CentralRef}"
          class="clearfix">

          <!-- Avatar -->
          <div class="chat-avatar">
            <img src="./assets/images/logo_color.png" class="rounded" alt="">
          </div>

          <!-- Message Content -->
          <div class="conversation-text">
            <div class="ctext-wrap">
              <i>{{ chat.Name }}</i>
              <i>{{ chat.CreationDate }}</i>

              <!-- Voice -->
              <!-- File preview button -->
              <ng-container [ngSwitch]="chat.ConversationText?.toLowerCase()">

                <!-- Voice -->
                <button *ngSwitchCase="'audio/mpeg'"
                  class="btn btn-outline-info rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-mic"></i>
                  <span>نمایش صدا</span>
                </button>

                <!-- Image -->
                <button *ngSwitchCase="'image'"
                  class="btn btn-outline-primary rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-image"></i>
                  <span>نمایش تصویر</span>
                </button>

                <!-- Video -->
                <button *ngSwitchCase="'video'"
                  class="btn btn-outline-warning rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-camera-video"></i>
                  <span>نمایش ویدئو</span>
                </button>

                <!-- PDF -->
                <button *ngSwitchCase="'pdf'"
                  class="btn btn-outline-danger rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-file-earmark-pdf"></i>
                  <span>نمایش PDF</span>
                </button>


                <button *ngSwitchCase="'zip'"
                  class="btn btn-outline-danger rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-file-earmark-pdf"></i>
                  <span>نمایش PDF</span>
                </button>

                <button *ngSwitchCase="'other'"
                  class="btn btn-outline-danger rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-file-earmark-pdf"></i>
                  <span>نمایش فایل</span>
                </button>


                <button *ngSwitchCase="'rar'"
                  class="btn btn-outline-danger rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-file-earmark-pdf"></i>
                  <span>نمایش فایل</span>
                </button>
                <!-- <button *ngSwitchDefault class="btn btn-outline-secondary rounded-pill d-flex align-items-center gap-2"
                  (click)="GetFileFromAttach(index)">
                  <i class="bi bi-paperclip"></i>
                                    <span>نمایش فایل</span>

                </button> -->

              </ng-container>

              <!-- Text -->
              <p>{{ chat.ConversationText }}</p>
            </div>
          </div>

          <!-- Dropdown Actions -->
          <div class="conversation-actions dropdown">
            <a class="btn-sm card-drop cursor-pointer dropdown-toggle" [id]="'react-aria'+index" aria-expanded="false">
              <i class="mdi mdi-dots-vertical font-16"></i>
            </a>
          </div>

        </li>
      </ul>
    </div>

    <!-- Chat Input -->
    <div class="mt-3 bg-light p-3 rounded">
      <form novalidate name="chat-form" id="chat-form">
        <div class="row">
          <!-- Text Input -->

          <div class="col mb-2 mb-sm-0">
            <input [(ngModel)]="newMessage" name="newMessage" class="border-2 form-control" placeholder="متن پیام..."
              (keyup.enter)="sendMessage()" />
          </div>

          <!-- Buttons -->
          <div class="col-sm-auto">
            <div class="btn-group">
              <!-- File Input -->
              <button type="button" class="btn btn-light" (click)="fileInput.click()">
                <i class="fe-paperclip"></i>
              </button>
              <input type="file" #fileInput style="display:none;" (change)="onFileSelected($event)" />

              <!-- Voice Recording -->
              <!-- <button type="button" class="btn" [ngClass]="isRecording ? 'btn-warning pulse-btn' : 'btn-danger'"
                [disabled]="isProcessing" (mousedown)="startRecording()" (mouseup)="stopRecording()"
                (mouseleave)="stopRecording()" (touchstart)="startRecording()" (touchend)="stopRecording()">

                <ng-container *ngIf="isRecording">{{recordSeconds}}</ng-container>
                <ng-container *ngIf="!isRecording && isProcessing">⏳ در حال پردازش...</ng-container>
                <ng-container *ngIf="!isRecording && !isProcessing && recordReady">✅ ویس آماده شد</ng-container>
                <ng-container *ngIf="!isRecording && !isProcessing && !recordReady">🎤</ng-container>
              </button> -->

              <!-- Send Message -->
              <button type="button" class="btn btn-success chat-send w-100" (click)="sendMessage()">
                <i class="fe-send"></i>
              </button>
            </div>
          </div>
        </div>
      </form>

      <div *ngIf="audioPreviewUrl" class="mt-2 d-flex flex-column gap-2">
        <div class="d-flex align-items-center gap-2">
          <audio #audioPlayer [src]="audioPreviewUrl" controls></audio>
          <button class="btn btn-success btn-sm" (click)="playAudio()">▶️ Play</button>
          <button class="btn btn-danger btn-sm" (click)="pauseAudio()">⏸ Pause</button>
          <button class="btn btn-success btn-sm" (click)="confirmVoice()">✔</button>
          <button class="btn btn-danger btn-sm" (click)="cancelVoice()">✖</button>
        </div>

        <!-- Transcribed Text -->
        <div *ngIf="voiceToText" class="p-2 border rounded bg-light">
          <strong>متن ویس:</strong>
          <p>{{ voiceToText }}</p>
        </div>
      </div>


    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="verticallyCenteredModal" tabindex="-1" aria-labelledby="verticallyCenteredModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class=" modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title" id="verticallyCenteredModalLabel">نمایش عکس</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center">
        <img [src]="Imageitem" alt="No Photo" class="img-fluid" style="max-height: 80vh; object-fit: contain;" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
      </div>
    </div>
  </div>
</div>


<!-- <div class="modal fade" id="voiceModal" tabindex="-1" aria-labelledby="voiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class=" modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title" id="voiceModalLabel">پخش صدا</h5>
        <button type="button" class="btn-close" (click)="voiceModal_close()" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <audio [src]="selectedVoiceUrl" controls autoplay></audio>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
          (click)="voiceModal_close()">بستن</button>
      </div>
    </div>
  </div>
</div> -->

<!-- Voice Modal -->
<div class="modal fade" id="voiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title">پخش صدا</h5>
        <button type="button" class="btn-close" (click)="closeModal('#voiceModal')"></button>
      </div>
      <div class="modal-body text-center">
        <audio [src]="data_resive_FileUrl" controls autoplay></audio>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title">نمایش تصویر</h5>
        <button type="button" class="btn-close" (click)="closeModal('#imageModal')"></button>
      </div>
      <div class="modal-body text-center">
        <img [src]="data_resive_FileUrl" class="img-fluid rounded" />
      </div>
    </div>
  </div>
</div>

<!-- PDF Modal -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title">نمایش PDF</h5>
        <button type="button" class="btn-close" (click)="closeModal('#pdfModal')"></button>
      </div>
      <div class="modal-body text-center">
        <iframe [src]="data_resive_FileUrl" width="100%" height="600px"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Other File Modal -->
<div class="modal fade" id="fileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background-color: #d1dce7;">
      <div class="modal-header" style="background-color: #949494;">
        <h5 class="modal-title">دانلود فایل</h5>
        <button type="button" class="btn-close" (click)="closeModal('#fileModal')"></button>
      </div>
      <div class="modal-body text-center">
        <a [href]="data_resive_FileUrl" [download]="data_resive_FileName">دانلود فایل</a>
      </div>
    </div>
  </div>
</div>